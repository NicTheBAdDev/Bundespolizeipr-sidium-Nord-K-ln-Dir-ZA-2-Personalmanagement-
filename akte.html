<!DOCTYPE html>
<html lang="de" data-role="guest">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Akte</title>
<script src="./auth.js"></script>
<style>
  :root{
    --bg:#0b1220; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.14);
    --text:#e5e7eb; --muted:#93a4b4; --accent:#22d3ee; --accent2:#a78bfa;
    --danger1:#fb7185; --danger2:#f43f5e;
    --shadow:0 8px 28px rgba(0,0,0,.35); --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}

  /* Topbar */
  .bar{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);
       border-radius:12px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)}
  .btn:hover{filter:brightness(1.06)}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;color:#0b1020;font-weight:800}
  .btn-danger{background:linear-gradient(135deg,var(--danger1),var(--danger2));border:0;color:white}

  /* Layout */
  .wrap{max-width:1200px;margin:0 auto;padding:0 20px 24px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}

  .head{display:grid;grid-template-columns:220px 1fr;gap:24px;align-items:start}
  @media(max-width:720px){.head{grid-template-columns:1fr}}
  .photo{
    width:100%;aspect-ratio:3/4;min-height:280px;
    background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
    display:grid;place-items:center;color:var(--muted);box-shadow:var(--shadow)
  }

  /* Felder – endgültig ohne Überschneiden */
  .fields{
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(0,1fr) 120px; /* VName, NName, DN */
    gap:20px; align-items:start;
  }
  .field{ min-width:0; } /* erlaubt Schrumpfen in Grid */
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}

  input{
    display:block;
    width:100%;
    background:rgba(255,255,255,.06);color:var(--text);
    border:1px solid var(--line);border-radius:12px;padding:10px;
    box-shadow:var(--shadow)
  }
  input:focus{outline:none;box-shadow:0 0 0 2px rgba(34,211,238,.25)} /* schlanker Fokus */
  #Dienstnummer{max-width:120px}

  @media (max-width:720px){
    .fields{ grid-template-columns:1fr; }
    #Dienstnummer{ max-width:100%; }
  }

  .gradeRow{margin-top:6px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .gradeRow label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}

  /* Schickes Dropdown */
  select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background:
      rgba(255,255,255,.06)
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white'><path d='M4 6l4 4 4-4z'/></svg>")
      no-repeat right 12px center;
    background-size:12px;
    color:var(--text);
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px 36px 10px 12px;
    width:100%;font:inherit;cursor:pointer;
    box-shadow:var(--shadow);
    transition:filter .2s ease, box-shadow .2s ease;
  }
  select:hover{ filter:brightness(1.08); }
  select:focus{ outline:none; box-shadow:0 0 0 2px rgba(34,211,238,.25); }
  select option{ color:var(--text); background-color:#111827; }

  .muted{color:var(--muted);font-size:12px}

  /* Dokumente */
  .docsCard{margin-top:22px;background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .docsHeader{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  .docsHeader h3{margin:0;font-size:16px}
  .docList{padding:12px}
  .docItem{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px;border:1px dashed var(--line);border-radius:12px;margin-bottom:10px}
  .docItem a{color:#93c5fd;text-decoration:none}
  .docItem a:hover{text-decoration:underline}

  /* rechte Spalte */
  .tagsCard{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .tagsCard h4{margin:0 0 10px 0}
  .stack{display:grid;gap:8px}
  .btn-wide{width:100%}

  /* Loader */
  #loading{position:fixed;inset:0;background:rgba(10,15,25,.96);color:var(--text);z-index:9999}
  #loading .loading-box{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center}
  .spinner{width:72px;height:72px;border-radius:50%;
    background:conic-gradient(var(--accent2) 0 90deg,transparent 90deg 360deg);
    -webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 8px),#000 0);
            mask:radial-gradient(farthest-side,transparent calc(100% - 8px),#000 0);
    animation:spin 1s linear infinite;filter:drop-shadow(0 0 10px rgba(167,139,250,.55)); margin:0 auto 18px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-title{font-weight:700;font-size:18px;margin-bottom:6px}
  #loading.hide{opacity:0;pointer-events:none;transition:opacity .25s ease}

  /* Toast */
  #toast{
    position:fixed;left:50%;bottom:28px;transform:translateX(-50%);
    background:rgba(18,24,40,.95);color:var(--text);
    border:1px solid var(--line);border-radius:12px;padding:10px 14px;
    box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .2s ease;
    z-index:10000;font-size:14px
  }
  #toast.show{opacity:1}

      /* === Top Gov bar (Logo + Title + Clock) === */
    .govbar{
      position: sticky; top: 0; z-index: 500;
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px;
      background: linear-gradient(180deg, rgba(11,16,32,.85), rgba(15,23,42,.85));
      border-bottom: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      justify-content: space-between;
    }
    .govbar .left{display:flex;align-items:center;gap:12px}
    .govbar .gov-logo{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:6px;background:#000;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.4)}
    .govbar .gov-logo img{width:100%;height:100%;object-fit:contain}
    .govbar .gov-title{font-size:clamp(16px,2vw,22px);font-weight:700;letter-spacing:.2px;color:#e5e7eb;text-shadow:0 1px 0 rgba(0,0,0,.4)}
    .gov-right{display:flex;align-items:center;gap:14px;margin-left:auto}
    .clock-pill{font-variant-numeric:tabular-nums;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e5e7eb;box-shadow:0 4px 14px rgba(0,0,0,.25) inset;min-width:72px;text-align:center}

    /* === Hero === */
    .hero{display:grid;gap:14px;padding:20px}
    .hero .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}

</style>
</head>
<body>

<!-- Government bar -->
<div class="govbar">
<div class="left">
<span class="gov-logo"><img alt="Bundespolizei Wappen" src="assets/Federal_Police_Patch.svg.png"/></span>
<span class="gov-title">Bundespolizeipräsidium Nord Köln</span>
</div>
<div class="gov-right"><span class="clock-pill" id="clock">--:--</span></div>
</div>

<!-- Loader & Toast -->
<div id="loading">
  <div class="loading-box">
    <div class="spinner"></div>
    <div class="loading-title">Akte wird geladen…</div>
  </div>
</div>
<div id="toast" role="status" aria-live="polite"></div>

<!-- Topbar -->
<div class="bar">
  <button class="btn" onclick="history.back()">⬅ Zurück</button>
  <div><strong id="title">Akte</strong> · <span id="roleInfo" class="muted">guest</span></div>
  <div>
    <button id="saveBtn" class="btn btn-primary" data-roles="admin dirza2 dirza3">Speichern</button>
    <button id="deleteBtn" class="btn btn-danger" style="display:none" data-roles="admin">Löschen</button>
  </div>
</div>

<main id="app" class="wrap" hidden>
  <div class="grid">
    <!-- Linke Spalte -->
    <section>
      <div class="head">
        <div class="photo">Bild</div>
        <div>
          <div class="fields">
            <div class="field"><label>Vorname</label><input id="Vorname" /></div>
            <div class="field"><label>Nachname</label><input id="Nachname" /></div>
            <div class="field"><label>DN</label><input id="Dienstnummer" maxlength="3" inputmode="numeric" pattern="[0-9]*" /></div>
          </div>

          <div class="gradeRow">
            <div style="flex:1;min-width:200px">
              <label>Dienstgrad</label>
              <select id="Dienstgrad">
                <option>Polizeimeisteranwärter</option>
                <option>Polizeimeister</option>
                <option>Polizeiobermeister</option>
                <option>Polizeihauptmeister</option>
                <option>Polizeikommissar</option>
                <option>Polizeioberkommissar</option>
                <option>Polizeihauptkommissar</option>
                <option>Erster Polizeihauptkommissar</option>
                <option>Polizeiratsanwärter</option>
                <option>Polizeirat</option>
              </select>
            </div>
            <div class="muted" id="gradChangedInfo" style="font-size:13px;margin-top:20px">
              Letzte Änderung: <span id="gradChangedDate">–</span>
            </div>
          </div>
        </div>
      </div>

      <div class="docsCard">
        <div class="docsHeader">
          <h3>Dokumenten-Übersicht</h3>
          <button id="addDocBtn" class="btn" data-roles="admin dirza2 dirza3">+ Neues Dokument</button>
        </div>
        <div class="docList" id="docsList"></div>
        <p id="docsEmpty" class="muted" style="display:none;margin:0 12px 12px">Noch keine Dokumente.</p>
      </div>
    </section>

    <!-- Rechte Spalte -->
    <aside>
      <div class="tagsCard">
        <h4>Aktionen</h4>
        <div class="stack">
          <button id="archiveBtn" class="btn btn-wide" data-roles="admin dirza2 dirza3">Entlassen</button>
          <button id="restoreBtn" class="btn btn-wide" style="display:none" data-roles="admin dirza2 dirza3">Reaktivieren</button>
          <button class="btn btn-wide" disabled>Urlaub (später)</button>
          <button class="btn btn-wide" disabled>Suspendiert (später)</button>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
/* ------------------------- Konfiguration ------------------------- */
const API='https://script.google.com/macros/s/AKfycbztNzJIkcPuy28ieg73HFUaRaR7kFbkf9bjqWpDiUgcHCeNghnQre887E9adqVGWIs/exec';
const $=s=>document.querySelector(s);
const id=new URLSearchParams(location.search).get('id')||'';

/* ------------------------- UI Helpers --------------------------- */
const appEl=$('#app'),loadingEl=$('#loading'),toastEl=$('#toast');
function showLoading(){ loadingEl.classList.remove('hide'); appEl.hidden=true; }
function hideLoading(){ loadingEl.classList.add('hide'); appEl.hidden=false; }
function showToast(msg,ms=1600){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),ms); }

function canEdit(role){ return ['admin','dirza2','dirza3'].includes((role||'').toLowerCase().trim()); }

/* ------------------------- Rollenlogik -------------------------- */
function getQueryRole(){const m=/[?&]role=([^&]+)/.exec(location.search);return m?decodeURIComponent(m[1]).toLowerCase():''}
function getLocalRole(){try{return(localStorage.getItem('role')||'').toLowerCase()||'guest'}catch(_){return'guest'}}
function setLocalRole(r){try{localStorage.setItem('role',r)}catch(_){}} 

function updateActionVisibility(){
  const role = (document.documentElement.dataset.role || 'guest').toLowerCase().trim();
  const editable = canEdit(role);
  const isAdmin  = role === 'admin';

  [$('#Vorname'),$('#Nachname'),$('#Dienstgrad'),$('#Dienstnummer')].forEach(el=> el && (el.disabled = !editable));
  $('#saveBtn').style.display    = editable ? 'inline-block' : 'none';
  $('#archiveBtn').style.display = editable && currentStatus!=='entlassen' ? 'inline-block' : 'none';
  $('#restoreBtn').style.display = editable && currentStatus==='entlassen' ? 'inline-block' : 'none';
  $('#deleteBtn').style.display  = isAdmin  && currentStatus==='entlassen' ? 'inline-block' : 'none';
  $('#addDocBtn').style.display  = editable ? 'inline-block' : 'none';

  const roleInfo=$('#roleInfo'); if(roleInfo) roleInfo.textContent = role + (editable ? ' (Bearbeiten)' : ' (Nur lesen)');
}

function applyRole(role){ document.documentElement.dataset.role=(role||'guest').toLowerCase().trim(); updateActionVisibility(); }

async function resolveRole(){
  const q=getQueryRole(); if(q){ setLocalRole(q); applyRole(q); return; }
  try{
    if (window.Auth && typeof Auth.session==='function'){
      const s=await Auth.session();
      if(s && s.role){ setLocalRole(String(s.role).toLowerCase().trim()); applyRole(getLocalRole()); return; }
    }
  }catch(_){}
  applyRole(getLocalRole());
}
window.addEventListener('storage',e=>{if(e.key==='role')applyRole(getLocalRole())});
setInterval(()=>{const r=getLocalRole(); if(r!==document.documentElement.dataset.role) applyRole(r)},2000);

/* -------------------------- API/JSONP --------------------------- */
function jsonp(url){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    const sep=url.includes('?')?'&':'?';
    s.src=url+sep+'callback='+cb+'&_ts='+Date.now();
    let done=false;
    const cleanup=()=>{delete window[cb];s.remove()};
    window[cb]=d=>{ if(!done){ done=true; cleanup(); res(d); } };
    s.onerror=()=>{ if(!done){ done=true; cleanup(); rej(new Error('JSONP error')); } };
    document.head.appendChild(s);
  });
}
async function apiGet(id){ const j=await jsonp(API+'?action=get&id='+encodeURIComponent(id)); if(!j.ok) throw new Error(j.error||'get fail'); return j.data; }
async function apiUpdate(p){
  const q=new URLSearchParams({action:'update',id:p.id});
  if('vorname'in p)q.set('vorname',p.vorname);
  if('nachname'in p)q.set('nachname',p.nachname);
  if('dienstnummer'in p)q.set('dienstnummer',p.dienstnummer);
  if('dienstgrad'in p)q.set('dienstgrad',p.dienstgrad);
  if('status'in p)q.set('status',p.status);
  if('dokumente'in p)q.set('dokumente',p.dokumente);
  const j=await jsonp(API+'?'+q.toString());
  if(!j.ok) throw new Error(j.error||'update fail');
  return true;
}
async function apiDelete(id){ const j=await jsonp(API+'?action=delete&id='+encodeURIComponent(id)); if(!j.ok) throw new Error(j.error||'delete fail'); return true; }

/* ------------------------ Daten & UI ---------------------------- */
let currentStatus='aktiv';
let docs=[];
const v=$('#Vorname'),n=$('#Nachname'),dn=$('#Dienstnummer'),dg=$('#Dienstgrad');
const titleEl=$('#title'),gradChangedDateEl=$('#gradChangedDate');
const docsList=$('#docsList'),docsEmpty=$('#docsEmpty');

function renderDocs(){
  docsList.innerHTML='';
  if(!docs || !docs.length){ docsEmpty.style.display='block'; return; }
  docsEmpty.style.display='none';
  for(const d of docs){
    const row=document.createElement('div'); row.className='docItem';
    const safeTitle=(d.title||'Dokument'); const safeUrl=(d.url||'#');
    row.innerHTML=`<div><strong>${safeTitle}</strong><br><a href="${safeUrl}" target="_blank" rel="noopener">Link öffnen</a></div>`;
    docsList.appendChild(row);
  }
}

function fill(r){
  titleEl.textContent='Akte – '+((r.vorname||'')+' '+(r.nachname||''));
  v.value=r.vorname||''; n.value=r.nachname||''; dn.value=r.dienstnummer||''; dg.value=r.dienstgrad||'Polizeimeisteranwärter';
  currentStatus=(r.status||'aktiv').toLowerCase().trim();

  // updated_at anzeigen
  if(r.updated_at){ gradChangedDateEl.textContent = new Date(r.updated_at).toLocaleString('de-DE'); }
  else { gradChangedDateEl.textContent = '–'; }

  try{
    if(Array.isArray(r.dokumente)) docs=r.dokumente;
    else if(typeof r.dokumente==='string' && r.dokumente.trim()) docs=JSON.parse(r.dokumente);
    else docs=[];
  }catch(_){ docs=[]; }
  renderDocs();
  updateActionVisibility();
}

/* ------------------------ Aktionen ----------------------------- */
$('#saveBtn').addEventListener('click', async ()=>{
  if(!canEdit(document.documentElement.dataset.role)) return alert('Keine Berechtigung.');
  const payload={id,vorname:v.value.trim(),nachname:n.value.trim(),dienstnummer:dn.value.trim(),dienstgrad:dg.value};
  if(!payload.vorname||!payload.nachname||!payload.dienstnummer) return alert('Pflichtfelder fehlen.');
  try{ showLoading(); await apiUpdate(payload); gradChangedDateEl.textContent = new Date().toLocaleString('de-DE'); showToast('Akte gespeichert'); }
  catch(e){ alert('Fehler: '+e.message); }
  finally{ hideLoading(); }
});

$('#archiveBtn').addEventListener('click', async ()=>{
  if(!canEdit(document.documentElement.dataset.role)) return alert('Keine Berechtigung.');
  try{ showLoading(); await apiUpdate({id,status:'entlassen'}); currentStatus='entlassen'; updateActionVisibility(); showToast('In „Entlassen“ verschoben'); }
  catch(e){ alert('Fehler: '+e.message); }
  finally{ hideLoading(); }
});

$('#restoreBtn').addEventListener('click', async ()=>{
  if(!canEdit(document.documentElement.dataset.role)) return alert('Keine Berechtigung.');
  try{ showLoading(); await apiUpdate({id,status:'aktiv'}); currentStatus='aktiv'; updateActionVisibility(); showToast('Reaktiviert'); }
  catch(e){ alert('Fehler: '+e.message); }
  finally{ hideLoading(); }
});

$('#deleteBtn').addEventListener('click', async ()=>{
  const role=(document.documentElement.dataset.role||'guest').toLowerCase();
  if(role!=='admin') return alert('Nur Admins dürfen löschen.');
  if(currentStatus!=='entlassen') return alert('Kann nur entlassene Beamte löschen.');
  if(!confirm('Diesen Beamten endgültig löschen? Dieser Vorgang kann nicht rückgängig gemacht werden.')) return;
  try{
    showLoading();
    await apiDelete(id);
    showToast('Akte gelöscht');
    const u=new URL('DirZA2- Personalakten.html', location.href);
    u.searchParams.set('role', role);
    location.href=u.toString();
  }catch(e){ alert('Löschen fehlgeschlagen: '+e.message); }
  finally{ hideLoading(); }
});

$('#addDocBtn').addEventListener('click', async ()=>{
  if(!canEdit(document.documentElement.dataset.role)) return alert('Keine Berechtigung.');
  const title=(prompt('Dokument-Titel?')||'').trim(); if(!title) return;
  const url=(prompt('Link (https://…) ?')||'').trim();
  if(!/^https?:\/\/.+/i.test(url)) return alert('Bitte eine gültige URL angeben.');
  docs=Array.isArray(docs)?docs:[];
  docs.push({title,url,ts:Date.now()});
  try{ showLoading(); await apiUpdate({id,dokumente:JSON.stringify(docs)}); renderDocs(); gradChangedDateEl.textContent = new Date().toLocaleString('de-DE'); showToast('Dokument gespeichert'); }
  catch(e){ alert('Konnte Dokument nicht speichern: '+e.message); }
  finally{ hideLoading(); }
});

/* -------------------------- Init ------------------------------- */
(async ()=>{
  try{
    showLoading();
    await resolveRole();               // erst Rolle
    if(!id) throw new Error('Keine id in URL.');
    const rec=await apiGet(id);        // dann Daten
    fill(rec);
    hideLoading();
  }catch(e){
    alert('Akte laden fehlgeschlagen: '+e.message);
  }
})();

// === Clock HH:MM (24h)
  const clockEl = document.getElementById('clock');
  function updateClock(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    if (clockEl) clockEl.textContent = `${hh}:${mm}`;
    }
    updateClock();
    setInterval(updateClock, 1000);
// Load auth.js dynamically (won't break page if missing)
  let Auth = null;
  (async () => {
    try {
/* global auth.js used; session will be called below */
    } catch (e) {
      console.warn('auth.js (global) wird erwartet – wenn fehlt, bleibt Gast-Modus', e);
    }
  })();
</script>
</body>
</html>
