<!DOCTYPE html>
<html lang="de" data-role="guest">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Personalakten – Übersicht</title>
<script src="./auth.js"></script>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb; --line:rgba(255,255,255,.12); --soft:rgba(255,255,255,.04); --yellow:#facc15 }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1224,#0f172a);color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  .h1{font-size:clamp(20px,2.6vw,28px);font-weight:800;margin:0}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:10px 14px;background:#334155;color:#e5e7eb;cursor:pointer}
  .btn-accent{background:linear-gradient(135deg,#22d3ee,#a78bfa);color:#0b1020;font-weight:800;border:0}
  .search{min-width:260px;background:rgba(255,255,255,.06);color:#e5e7eb;border:1px solid var(--line);border-radius:12px;padding:10px}
  .tabs{display:flex;gap:6px;align-items:center}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);cursor:pointer;background:rgba(255,255,255,.06)}
  .tab.active{background:linear-gradient(135deg,#22d3ee,#a78bfa);color:#0b1020;border:0;font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media(max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:700px){.grid{grid-template-columns:1fr}}
  .card{background:var(--soft);border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;align-items:center;justify-content:space-between}
  .left{display:flex;flex-direction:column;gap:6px}
  .name{font-weight:700;font-size:16px}
  .dn{opacity:.85;font-size:13px}
  .grad{background:var(--yellow);color:#111827;font-weight:700;font-size:14px;padding:4px 10px;border-radius:6px;display:inline-block;margin-top:4px}
  .muted{opacity:.75;font-size:12px;text-align:center;margin-top:14px}

  /* Role gating: guest sieht +Neuer Beamter NICHT */
  [data-roles]{display:none !important}
  html[data-role="guest"]  [data-roles~="guest"]  {display:inline-flex !important}
  html[data-role="admin"]  [data-roles~="admin"]  {display:inline-flex !important}
  html[data-role="dirza2"] [data-roles~="dirza2"] {display:inline-flex !important}
  html[data-role="dirza3"] [data-roles~="dirza3"] {display:inline-flex !important}

      /* === Top Gov bar (Logo + Title + Clock) === */
    .govbar{
      position: sticky; top: 0; z-index: 500;
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px;
      background: linear-gradient(180deg, rgba(11,16,32,.85), rgba(15,23,42,.85));
      border-bottom: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      justify-content: space-between;
    }
    .govbar .left{display:flex;align-items:center;gap:12px}
    .govbar .gov-logo{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:6px;background:#000;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.4)}
    .govbar .gov-logo img{width:100%;height:100%;object-fit:contain}
    .govbar .gov-title{font-size:clamp(16px,2vw,22px);font-weight:700;letter-spacing:.2px;color:#e5e7eb;text-shadow:0 1px 0 rgba(0,0,0,.4)}
    .gov-right{display:flex;align-items:center;gap:14px;margin-left:auto}
    .clock-pill{font-variant-numeric:tabular-nums;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e5e7eb;box-shadow:0 4px 14px rgba(0,0,0,.25) inset;min-width:72px;text-align:center}

    /* === Hero === */
    .hero{display:grid;gap:14px;padding:20px}
    .hero .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}

</style>
</head>
<body>

<!-- Government bar -->
<div class="govbar">
<div class="left">
<span class="gov-logo"><img alt="Bundespolizei Wappen" src="assets/Federal_Police_Patch.svg.png"/></span>
<span class="gov-title">Bundespolizeipräsidium Nord Köln</span>
</div>
<div class="gov-right"><span class="clock-pill" id="clock">--:--</span></div>
</div>


  <main class="wrap">
    <header>
      <h1 class="h1">Personalakten</h1>
      <div class="toolbar">
        <div class="tabs">
          <button id="tabAktiv" class="tab active">Aktive</button>
          <button id="tabEnt" class="tab">Entlassene</button>
        </div>
        <input id="search" class="search" placeholder="Suche: Dienstnummer, Vorname, Nachname, Dienstgrad ..." />
        <button id="addBtn" class="btn-accent" data-roles="admin dirza2 dirza3">+ Neuer Beamter</button>
        <a class="btn" href="index.html">Start</a>
      </div>
    </header>

    <div style="opacity:.8;font-size:12px;margin-bottom:8px">Rolle: <span id="roleInfo">guest</span></div>

    <div id="grid" class="grid"></div>
    <p id="empty" class="muted" style="display:none">Keine Akten im gewählten Bereich.</p>
  </main>

<script>
const API = 'https://script.google.com/macros/s/AKfycbw3yxr0ylI9zqvSCmAlcmLk3dy-emQ0KzEWgpIH8qNHQnUvq-UxnTzbJ9rec5MYGfD4/exec';
const $ = s => document.querySelector(s);
const grid=$('#grid'), emptyEl=$('#empty'), searchEl=$('#search'), roleInfo=$('#roleInfo');
const tabAktiv=$('#tabAktiv'), tabEnt=$('#tabEnt'); let currentStatus='aktiv', cache=[], query='';

function setRole(role){
  document.documentElement.dataset.role=(role||'guest').toLowerCase();
  roleInfo.textContent=document.documentElement.dataset.role;
}
(async function initSession(){
  try{
    if(window.Auth && typeof Auth.session==='function'){
      const s=await Auth.session(); setRole(s.role||'guest');
    } else {
      setRole(localStorage.getItem('role')||'guest');
    }
  }catch(e){ setRole('guest'); }
})();

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    const sep=url.includes('?')?'&':'?';
    s.src=url+sep+'callback='+cb+'&_ts='+Date.now();
    let done=false; const cleanup=()=>{ delete window[cb]; s.remove(); };
    window[cb]=(data)=>{ if(!done){ done=true; cleanup(); resolve(data); } };
    s.onerror=()=>{ if(!done){ done=true; cleanup(); reject(new Error('JSONP error')); } };
    document.head.appendChild(s);
  });
}

async function apiList(status){
  const j=await jsonp(API+'?action=list&status='+encodeURIComponent(status||'aktiv'));
  if(!j.ok) throw new Error(j.error||'list failed');
  return j.data||[];
}
async function apiCreate(entry){
  const p=new URLSearchParams({ action:'create', vorname:entry.vorname, nachname:entry.nachname, dienstnummer:entry.dienstnummer });
  const j=await jsonp(API+'?'+p.toString());
  if(!j.ok) throw new Error(j.error||'create failed');
  return j.id;
}

function render(){
  const q=(query||'').toLowerCase().trim();
  const list=cache
    .sort((a,b)=> (a.nachname||'').localeCompare(b.nachname||'','de') || (a.vorname||'').localeCompare(b.vorname||'','de'))
    .filter(x=> !q ? true : [x.vorname,x.nachname,x.dienstnummer,x.dienstgrad,(x.tags||[]).join(' ')].join(' ').toLowerCase().includes(q));

  grid.innerHTML=''; emptyEl.style.display=list.length?'none':'block';
  for(const e of list){
    const card=document.createElement('div'); card.className='card';
    const left=document.createElement('div'); left.className='left';
    left.innerHTML =
      '<div class="name">'+((e.vorname||'')+' '+(e.nachname||''))+'</div>'+
      '<div class="dn">Dienstnummer: '+(e.dienstnummer||'—')+'</div>'+
      '<div class="grad">'+(e.dienstgrad||'Polizeimeisteranwärter')+'</div>';
    const right=document.createElement('div');
    right.innerHTML = '<a class="btn" href="akte.html?id='+encodeURIComponent(e.id)+'">Öffnen</a>';
    card.appendChild(left); card.appendChild(right); grid.appendChild(card);
  }
}

async function reload(){
  try{
    cache=await apiList(currentStatus);
    render();
  }catch(e){ alert('Konnte Liste nicht laden: '+e.message); }
}

function setTab(status){
  currentStatus=status;
  tabAktiv.classList.toggle('active', status==='aktiv');
  tabEnt.classList.toggle('active', status==='entlassen');
  reload();
}
tabAktiv.addEventListener('click', ()=> setTab('aktiv'));
tabEnt.addEventListener('click', ()=> setTab('entlassen'));
searchEl.addEventListener('input', e=>{ query=e.target.value; render(); });

// "+ Neuer Beamter" – nur sichtbar für admin/dirza2/dirza3 (per CSS gating)
document.getElementById('addBtn').addEventListener('click', async ()=>{
  const vorname=prompt('Vorname?'); if(!vorname) return;
  const nachname=prompt('Nachname?'); if(!nachname) return;
  const dn=prompt('Dienstnummer?'); if(!dn) return;
  try{
    await apiCreate({ vorname, nachname, dienstnummer: dn });
    await reload();
  }catch(e){ alert('Anlegen fehlgeschlagen: '+e.message); }
});

(async ()=>{
  await reload();
  setInterval(reload, 60*1000); // Auto-Refresh jede Minute
})();

// === Clock HH:MM (24h)
  const clockEl = document.getElementById('clock');
  function updateClock(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    if (clockEl) clockEl.textContent = `${hh}:${mm}`;
    }
    updateClock();
    setInterval(updateClock, 1000);
</script>
</body>
</html>
